{% extends "web/base.html" %}
{% load static %}
{% block title %}Filmstreator{% endblock %}

{% block body %}

<nav class="notbody navbar navbar-dark bg-dark top-navbar top-nav">
    <a class="text_with_2px_border navbar-brand" href="/">Filmstreator</a>
    {% include 'web/fragment_landing_filters.html' %}
</nav>

{% if genres_names %}
<nav class="navbar navbar-default navbar-static-top second-nav">
    {% for genres_name in genres_names %}
        {% if forloop.counter < 6 %}
        <li class="nav-item{% if genres_name == current_genre %} active{% endif %}">
            <a class="nav-link" href="/genres/{{ genres_name }}/">{{ genres_name }}<span class="sr-only">(current)</span></a>
        </li>
        {% endif %}
    {% endfor %}

    {% if genres_names|length > 5 %}

    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            More
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            {% for genres_name in genres_names %}
                {% if forloop.counter > 5 %}
                <a class="dropdown-item{% if genres_name == current_genre %} active{% endif %}" href="/genres/{{ genres_name }}/">{{ genres_name }}</a>
                {% endif %}
            {% endfor %}
        </div>
    </li>
    {% endif %}
</nav>
{% endif %}

{% if is_landing %}
<div class="wrapper">
    <section class="content">
{% endif %}
    <div class="main-container {% if is_landing %}container-fluid{% else %}container{% endif %}">
        {% block content %}{% endblock %}
    </div>
{% if is_landing %}
    </section>
    <nav class="sidebar">
    <!-- {'formtype': 'advanced', 'genres__name__in': ['Crime', 'Drama'], 'year__gte': '1970', 'year__lte': '2019'} -->
        <br>
        <h5>Advanced search
            <a href="#" data-toggle="tooltip" data-placement="bottom"
               title="All fields are optional. If any of them (or all) are empty, search wont use them.">
                <i class="fa fa-info-circle" aria-hidden="true"></i>
            </a>
        </h5>

        <form id="advanced-search-form" action="/s/" method="GET" autocomplete="off">
            <input type="hidden" name="formtype" value="advanced">
            <label>Title:</label>
            <input type="text" class="form-control" placeholder="Search" name="search"
                    value="{% if filter_params.formtype == 'advanced' %}{{ filter_params.search }}{% endif %}">

            <label>Ordering:</label>
            <select name="ordering" class="form-control">
                <option value="-global_score"{% if filter_params.ordering == '-global_score' %} selected="selected"{% endif %}>Score from best to worst</option>
                <option value="global_score"{% if filter_params.ordering == 'global_score' %} selected="selected"{% endif %}>Score from worst to best</option>
            </select>
            <label>Wanted genres:</label>
            <select id="genres-select" class="form-control" name="genres__in" multiple="multiple" size="7">
                {% for genres_name in genres_names %}
                    <option value="{{ genres_name }}"
                    {% if genres_name in filter_params.genres__name__in %} selected="selected"{% endif %}>{{ genres_name }}</option>
                {% endfor %}
            </select>
            <label>Film from year:</label>
            <select name="year__gte" class="form-control">
                {% for y in year_range %}
                <option value="{{ y }}"{% if y == filter_params.year__gte %} selected="selected"{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
            <label>To year:</label>
            <select name="year__lte" class="form-control">
                {% if filter_params.year__lte %}
                    {% for y in year_range %}
                        <option a="a" value="{{ y }}"{% if y == filter_params.year__lte %} selected="selected"{% endif %}>{{ y }}</option>
                    {% endfor %}
                {% else %}
                    {% for y in year_range %}
                        <option b="b" value="{{ y }}"{% if forloop.last %} selected="selected"{% endif %}>{{ y }}</option>
                    {% endfor %}
                {% endif %}
            </select>
            <br>
            <div class="text-center">
                <input type="submit" name="submit" value="Search" class="btn btn-secondary">
            </div>
            <br><br>
        </form>
    </nav>
</div>
{% endif %}
<!-- footer -->
{% include 'web/fragment_footer.html' %}
{% endblock %}


{% block body_extra_js %}
<script>
$('#advanced-search-form').on('submit', function (event) {
    event.preventDefault();

    var selectedGenresArray = [];
    $('#genres-select :selected').each(function(i, selected){
        selectedGenresArray.push($(selected).text());
    });

    var selectedGenres = selectedGenresArray.join(',');
    var searchSimilar = $("#advanced-search-form input[name=search]").val();
    var ordering = $("#advanced-search-form select[name=ordering]").val();
    var yearGte = $("#advanced-search-form select[name=year__gte]").val();
    var yearLte = $("#advanced-search-form select[name=year__lte]").val();

    var url = '/s/?formtype=advanced';
    if(searchSimilar !== '') url += '&search=' + searchSimilar;
    if (selectedGenres !== '') url += '&genres__name__in=' + selectedGenres;
    url += '&year__gte=' + yearGte;
    url += '&year__lte=' + yearLte;
    url += '&ordering=' + ordering;
    window.location = url;
});
</script>
{% endblock %}
